<%- include('../partials/header'); %>

<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">Invoices</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active">Invoices</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <div class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title mt-1">Invoice List</h3>
              <div class="card-tools">
                <a href="/invoice/create" class="btn btn-primary btn-sm">
                  <i class="fas fa-plus"></i> New Invoice
                </a>
              </div>
            </div>
            <div class="card-body">
              <table
                id="invoiceTable"
                class="table table-bordered table-striped"
              >
                <thead>
                  <tr>
                    <th>Invoice #</th>
                    <th>Firm</th>
                    <th>Client</th>
                    <th>Issue Date</th>
                    <th>Due Date</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    // Initialize DataTable
    const table = $("#invoiceTable").DataTable({
      processing: true,
      serverSide: false,
      ajax: {
        url: "/api/invoices",
        dataSrc: "",
      },
      columns: [
        { data: "invoiceNumber" },
        {
          data: "Firm",
          render: function (data) {
            return data ? data.name : "N/A";
          },
        },
        {
          data: "Client",
          render: function (data) {
            return data ? data.name : "N/A";
          },
        },
        {
          data: "issueDate",
          render: function (data) {
            return new Date(data).toLocaleDateString();
          },
        },
        {
          data: "dueDate",
          render: function (data) {
            return new Date(data).toLocaleDateString();
          },
        },
        {
          data: "total",
          render: function (data, type, row) {
            return `${row.currency} ${parseFloat(data).toFixed(2)}`;
          },
        },
        {
          data: "status",
          render: function (data) {
            const statusClasses = {
              draft: "badge badge-secondary",
              sent: "badge badge-info",
              paid: "badge badge-success",
              overdue: "badge badge-danger",
              cancelled: "badge badge-warning",
            };
            return `<span class="${statusClasses[data]}">${
              data.charAt(0).toUpperCase() + data.slice(1)
            }</span>`;
          },
        },
        {
          data: "id",
          render: function (data) {
            return `
            <div class="btn-group">
              <a href="/invoice/${data}" class="btn btn-info btn-sm">
                <i class="fas fa-eye"></i>
              </a>
              <a href="/invoice/${data}/edit" class="btn btn-primary btn-sm">
                <i class="fas fa-edit"></i>
              </a>
              <button type="button" class="btn btn-danger btn-sm" onclick="deleteInvoice(${data})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          },
        },
      ],
      order: [[2, "desc"]], // Sort by issue date by default
      pageLength: 10,
      language: {
        search: "Search invoices:",
      },
    });
  });

  // Delete invoice function
  function deleteInvoice(id) {
    if (confirm("Are you sure you want to delete this invoice?")) {
      $.ajax({
        url: `/api/invoices/${id}`,
        method: "DELETE",
        success: function (response) {
          $("#invoiceTable").DataTable().ajax.reload();
        },
        error: function (xhr, status, error) {
          alert("Error deleting invoice: " + error);
        },
      });
    }
  }
</script>

<%- include('../partials/footer'); %>
